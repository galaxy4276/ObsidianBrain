![Untitled](Untitled%2034.png)

# μ›Ή μ†μΌ“ ν•µμ‹¬ ν¬μΈνΈ

- μ›Ή μ†μΌ“μ€ λ³Έμ§μ μΌλ΅ μ–‘λ°©ν–¥ ν†µμ‹ μ…λ‹λ‹¤.
- μ›Ή μ†μΌ“μ„ μ‚¬μ©ν•μ—¬ κ°λ°λ μ—°κ²°μ€ μ°Έμ—¬μ(ν΄λΌμ΄μ–ΈνΈ λλ” μ„λ²„) μ¤‘ ν• λ…μ΄ μ—°κ²°μ„ λ‹«μ„ λ•κΉμ§€ μ§€μ†λ©λ‹λ‹¤.
- μ›Ή μ†μΌ“μ€ HTTP λ¥Ό μ‚¬μ©ν•μ—¬ μ—°κ²°μ„ μ‹μ‘ν•©λ‹λ‹¤.

# μ›Ή μ†μΌ“μ„ μ™ μ‚¬μ©ν• κΉ?

μ›Ήμ†μΌ“μ€ μ•μ •μ μ΄κ³  μ‚¬μ©ν•κΈ° μ‰¬μ°λ©° μ‹¤μ‹κ°„μ„±μ΄ μ”κµ¬λλ” μ‹μ¤ν…μ—μ„ ν° μ—­ν• μ„ ν•©λ‹λ‹¤.

μ§€μ†μ μΌλ΅ λ³€ν™”ν•λ” λ°μ΄ν„°λ¥Ό μ‹¤μ‹κ°„μΌλ΅ ν‘μ‹ν•΄μ•Ό ν•λ” μ• ν”λ¦¬μΌ€μ΄μ…μ—μ„ μ‘μ—…ν•κ³  μλ‹¤κ³  κ°€μ •ν•΄ λ³΄κ² μµλ‹λ‹¤. 

κ°€μ¥ λ¨Όμ € μ›Ή μ†μΌ“μ„ κµ¬ν„ν•΄μ•Ό ν•©λ‹λ‹¤. 

λ‹¤λ¥Έ λ°©λ²•λ„ μμ§€λ§ μ„λ²„μ μ¤λ²„ν—¤λ“κ°€ μ¦κ°€ν•λ―€λ΅ κ²°κµ­ λ‹¤λ¥Έ μ‹ λΆ°ν•  μ μλ” λ°©λ²•μ„ μ°Ύμ•„μ•Ό ν•©λ‹λ‹¤.

λ”°λΌμ„ μ΄λ¬ν• μ¤λ²„ν—¤λ“λ¥Ό μ¤„μ΄κΈ° μ„ν•΄ μ›Ήμ†μΌ“μ„ μ„ νƒ μ‚¬ν•­μΌλ΅ κ³ λ ¤ν•  μ μμµλ‹λ‹¤.

> **μ‹¤μ‹κ°„μ„ μ”κµ¬ν•λ” μ‹μ¤ν…μ—μ„ μ¤λ²„ν—¤λ“λ¥Ό μ¤„μ΄κΈ° μ„ν• μ„ νƒμ‚¬ν•­μ„**
> 

![ν΄λΌμ΄μ–ΈνΈμ™€ μ„λ²„ κ°„μ ν•Έλ“μ…°μ΄ν¬κ°€ μ„¤μ •λλ©΄ μ—°κ²°μ΄ λμ–΄μ§ λ•κΉμ§€ μ—°κ²°μ΄ μ§€μ†λ©λ‹λ‹¤(μ›Ήμ†μΌ“).](Untitled%2035.png)

ν΄λΌμ΄μ–ΈνΈμ™€ μ„λ²„ κ°„μ ν•Έλ“μ…°μ΄ν¬κ°€ μ„¤μ •λλ©΄ μ—°κ²°μ΄ λμ–΄μ§ λ•κΉμ§€ μ—°κ²°μ΄ μ§€μ†λ©λ‹λ‹¤(μ›Ήμ†μΌ“).

# μ›Ή μ†μΌ“ μ‘λ™λ°©μ‹

μ›Ήμ†μΌ“μ€ ν΄λΌμ΄μ–ΈνΈμ™€ μ„λ²„ κ°„μ μ—°κ²°μ„ ν†µν•΄ μ‘λ™ν•©λ‹λ‹¤. 

μ—°κ²°μ„ μ‹μ‘ν•κΈ° μ„ν•΄ ν΄λΌμ΄μ–ΈνΈλ” μ—…κ·Έλ μ΄λ“ ν—¤λ”κ°€ ν¬ν•¨λ http GET μ”μ²­μ„ λ³΄λ‚΄λ©΄ μ„λ²„λ” μ΄κ²ƒμ΄ μ—…κ·Έλ μ΄λ“ μ”μ²­μ„μ„ μ•κ³  μ„λ²„κ°€ μ—…κ·Έλ μ΄λ“ μ†μ„±μ„ μ§€μ›ν•λ” κ²½μ° μƒνƒ 101λ΅ μ‘λ‹µν•κ³  μ§€μ›ν•μ§€ μ•λ” κ²½μ° μ¤λ¥ μ½”λ“λ¥Ό λ°ν™ν•©λ‹λ‹¤.

μ„λ²„μ—μ„ 101 μ΄μ™Έμ μ½”λ“κ°€ λ°ν™λλ©΄ ν΄λΌμ΄μ–ΈνΈλ” μ—°κ²°μ„ μΆ…λ£ν•΄μ•Ό ν•©λ‹λ‹¤.

<aside>
π’΅ **[101 Switching Protocols](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/101)**

</aside>

```bash
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
```

μ›Ήμ†μΌ“μ€ ν΄λΌμ΄μ–ΈνΈμ™€ μ„λ²„λ¥Ό ν• λ²λ§ μ—°κ²°ν•λ―€λ΅ ν†µμ‹ ν•  λ•λ§λ‹¤ μ„λ²„μ™€ ν•Έλ“μ…°μ΄ν¬λ¥Ό ν•΄μ•Ό ν•λ” μ¤λ²„ν—¤λ“κ°€ μ—†λ‹¤λ” μ μ΄ κ³ λ ¤λ©λ‹λ‹¤.

## μ—°κ²° μ„¤μ •(Connection Setup)

μ—°κ²° μ„¤μ •μ€ ν΄λΌμ΄μ–ΈνΈμ—μ„ ν•Έλ“μ…°μ΄ν¬λ¥Ό μ”μ²­ν•λ” κ²ƒμΌλ΅ μ‹μ‘λ©λ‹λ‹¤.

![Untitled](Untitled%2036.png)

μ›Ήμ†μΌ“ μ—°κ²°μ„ μƒμ„±ν•κ³  μ‹¶λ‹¤λ” κ²ƒμ„ μ„λ²„μ— μ•λ¦¬κΈ° μ„ν•΄ ν΄λΌμ΄μ–ΈνΈκ°€ λ³΄λ‚΄μ•Ό ν•λ” νΉμ • ν—¤λ”κ°€ μμµλ‹λ‹¤. 

μ”μ²­μ€ **http GET λ©”μ„λ“λ¥Ό μ‚¬μ©**ν•μ—¬ μ΄λ£¨μ–΄μ§‘λ‹λ‹¤.

```bash
GET /chat HTTP/1.1
Host: server.example.com
Upgrade: websocket       
Connection: Upgrade        
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==        
Origin: http://example.com        
Sec-WebSocket-Protocol: chat, superchat        
Sec-WebSocket-Version: 13
```

**Sec-WebSocket-Key**: 16λ°”μ΄νΈ κ°’μ„ λ¬΄μ‘μ„λ΅ μ„ νƒν•μ—¬ μƒμ„±λλ” Base64 μΈμ½”λ”© κ°’μ…λ‹λ‹¤.

**Sec-Websocket-Protocol**: ν΄λΌμ΄μ–ΈνΈκ°€ μ‚¬μ©ν•  ν”„λ΅ν† μ½μ„ μ§€μ •ν•κΈ° μ„ν•΄ μ „μ†΅ν•©λ‹λ‹¤. (μ„ νƒ μ‚¬ν•­)

**Sec-WebSocket-Version:** ν΄λΌμ΄μ–ΈνΈκ°€ ν—μ©ν•  μ μλ” ν•μ„ ν”„λ΅ν† μ½(μ›Ή μ†μΌ“ ν”„λ΅ν† μ½ μ„μ— κ³„μΈµν™”λ μ• ν”λ¦¬μΌ€μ΄μ… μμ¤€ ν”„λ΅ν† μ½)μ„ λ‚νƒ€λ‚΄κΈ° μ„ν•΄ μ „μ†΅λ©λ‹λ‹¤(μ„ νƒ μ‚¬ν•­).

λ‹¤μ μ”μ²­μ„ λ°›μΌλ©΄ μ„λ²„λ” λ‹¤μ μ‘μ—…μ„ μν–‰ν•©λ‹λ‹¤.

- ν•Έλ“μ…°μ΄ν¬κ°€ μμ‹ λμ—μμ„ μ¦λ…ν•κΈ° μ„ν•΄ μ”μ²­ ν—¤λ”μ—μ„ Sec-WebSocket-keyλ¥Ό κ°€μ Έμ™€μ„ μ „μ—­ κ³ μ  μ‹λ³„μμ™€ κ²°ν•©ν•κ³  μ΄ μ—°κ²° λ¬Έμμ—΄μ SHA-1 ν•΄μ‹λ¥Ό μƒμ„±ν•΄μ•Ό ν•©λ‹λ‹¤.

κ·Έλ° λ‹¤μ base64λ¥Ό μ‚¬μ©ν•μ—¬ ν•΄λ‹Ή λ¬Έμμ—΄μ„ μΈμ½”λ”©ν•κ³  μ„λ²„ ν•Έλ“μ…°μ΄ν¬λ΅ λ°ν™ν•©λ‹λ‹¤.

```bash
HTTP/1.1 101 Switching Protocols
        Upgrade: websocket
        Connection: Upgrade
        Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
        Sec-WebSocket-Protocol: chat
```

101 μƒνƒ μ½”λ“λ΅ μ‘λ‹µν•λ©°, 101 μ΄μ™Έμ μ½”λ“λ” μ¤λ¥λ¥Ό μλ―Έν•λ©° μ›Ήμ†μΌ“ ν•Έλ“μ…°μ΄ν¬κ°€ μ™„λ£λμ§€ μ•μ•μμ„ μλ―Έν•©λ‹λ‹¤.

**Sec-WebSocket-Accept:** μ„λ²„κ°€ μ—°κ²° μ”μ²­μ„ μλ½ν• μ§€ μ—¬λ¶€λ¥Ό λ‚νƒ€λƒ…λ‹λ‹¤. μ΄ ν•„λ“κ°€ μλ” κ²½μ° μ΄ ν•„λ“μ—λ” Sec-WebSocket-ν‚¤μ™€ μ „μ—­ κ³ μ  μ‹λ³„μλ¥Ό κ²°ν•©ν• base64 μΈμ½”λ”© ν•΄μ‹κ°€ ν¬ν•¨λ©λ‹λ‹¤.

**Sec-WebSocket-Protocol:** μ„ νƒμ  ν•„λ“λ΅, μ„λ²„κ°€ ν†µμ‹ μ„ μ„ν•΄ μ„ νƒν• ν”„λ΅ν† μ½μ„ λ‚νƒ€λƒ…λ‹λ‹¤.

μ΄λ¬ν• ν•„λ“λ” μ¤ν¬λ¦½ν…λ νμ΄μ§€μ— λ€ν•΄ WebSocket ν΄λΌμ΄μ–ΈνΈμ—μ„ ν™•μΈν•λ©°, Sec-WebSocket-Accept κ°’μ΄ μμƒ κ°’κ³Ό μΌμΉν•μ§€ μ•κ±°λ‚ ν—¤λ” ν•„λ“κ°€ λ„λ½λκ±°λ‚ HTTP μƒνƒ μ½”λ“κ°€ 101μ΄ μ•„λ‹ κ²½μ° μ—°κ²°μ΄ μ„¤μ •λμ§€ μ•κ³  WebSocket ν”„λ μ„μ΄ μ „μ†΅λμ§€ μ•μµλ‹λ‹¤.

## μ›Ή μ†μΌ“μ κΈ°λ³Έ URL ν•μ‹

```bash
ws-URI = "ws:" "//" host [ ":" port ] path [ "?" query ]
wss-URI = "wss:" "//" host [ ":" port ] path [ "?" query ]
```

wss λ” λ³΄μ• ν”„λ΅ν† μ½μ΄λ―€λ΅ λ³΄μ• ν†µμ‹ μ„ μ„ν•΄ μ„λ²„μ™€ ν΄λΌμ΄μ–ΈνΈ κ°„μ— TLS ν•Έλ“μ…°μ΄ν¬κ°€ μν–‰λ©λ‹λ‹¤.

# μ›Ή μ†μΌ“ κµ¬μ΅°

![μ›Ήμ†μΌ“ ν”„λ μ„](Untitled%2037.png)

μ›Ήμ†μΌ“ ν”„λ μ„

μ›Ήμ†μΌ“μ **ν”„λ μ„**μ€ **ν΄λΌμ΄μ–ΈνΈμ™€ μ„λ²„ κ°„μ— κµν™λλ” λ°μ΄ν„°μ κΈ°λ³Έ λ‹¨μ„**μ…λ‹λ‹¤.

μ›Ήμ†μΌ“ ν”„λ΅ν† μ½μ—μ„ λ°μ΄ν„°λ” μΌλ ¨μ ν”„λ μ„μ„ μ‚¬μ©ν•μ—¬ μ „μ†΅λ©λ‹λ‹¤. 

ν΄λΌμ΄μ–ΈνΈλ” ν”„λ μ„μ„ μ„λ²„λ΅ λ³΄λ‚΄κΈ° μ „μ— λ§μ¤ν‚Ήν•΄μ•Ό ν•λ©°, λ§μ¤ν‚Ήλμ§€ μ•μ€ ν”„λ μ„μ΄ μ„λ²„μ— μμ‹ λλ©΄ μ„λ²„λ” μ—°κ²°μ„ λ‹«μ•„μ•Ό ν•©λ‹λ‹¤.

**FIN (1λΉ„νΈ) -** λ©”μ‹μ§€μ λ§μ§€λ§‰ μ΅°κ°μΈμ§€ μ—¬λ¶€λ¥Ό λ‚νƒ€λƒ…λ‹λ‹¤. κ°’ 1μ€ Trueλ¥Ό λ‚νƒ€λƒ…λ‹λ‹¤. μ²« λ²μ§Έ μ΅°κ°μ΄ μµμΆ… μ΅°κ°μΌ μλ„ μμµλ‹λ‹¤.

**RSV1, RSV2, RSV3(κ° 1λΉ„νΈ)** - 0 κ°’μ΄μ–΄μ•Ό ν•©λ‹λ‹¤. 0μ΄ μ•„λ‹ κ°’μΈ κ²½μ° 0μ΄ μ•„λ‹ κ°’μ μλ―Έλ¥Ό μ •μν•λ” ν™•μ¥μλ¥Ό μ •μν•΄μ•Ό ν•©λ‹λ‹¤.

**Opcode(4λΉ„νΈ)** - νμ΄λ΅λ“ λ°μ΄ν„°λ¥Ό μ •μν•λ©°, λ‹¤μ κ°’ μ¤‘ ν•λ‚λ¥Ό κ°€μ Έμ•Ό ν•©λ‹λ‹¤.

```bash
*  %x0 denotes a continuation frame
*  %x1 denotes a text frame
*  %x2 denotes a binary frame
*  %x3-7 are reserved for further non-control frames
*  %x8 denotes a connection close
*  %x9 denotes a ping
*  %xA denotes a pong
*  %xB-F are reserved for further control frames
```

**Mask (1λΉ„νΈ)** - λ§ν‚Ή μ‚¬μ© μ—¬λ¶€λ¥Ό μ •μν•λ©°, 1λ΅ μ„¤μ •ν•λ©΄ λ§μ¤ν‚Ή ν‚¤λ„ μ •μν•΄μ•Ό ν•©λ‹λ‹¤. "νμ΄λ΅λ“ λ°μ΄ν„°"μ λ§μ¤ν‚Ήμ„ ν•΄μ ν•λ” λ° μ‚¬μ©λλ©°, λ¨λ“  ν΄λΌμ΄μ–ΈνΈλ” λ§ν¬ κ°’μ„ 1λ΅ λ³΄λ‚΄κ³  λ§μ¤ν‚Ή ν‚¤λ„ ν•¨κ» λ³΄λ‚΄μ•Ό ν•©λ‹λ‹¤.

**Masking-Key(0 λλ” 4λ°”μ΄νΈ)** - ν΄λΌμ΄μ–ΈνΈμ—μ„ μ „μ†΅λλ” λ¨λ“  ν”„λ μ„μ€ μ΄ ν‚¤λ¥Ό μ‚¬μ©ν•μ—¬ λ§μ¤ν‚Ήλ©λ‹λ‹¤. λ§μ¤ν‚Ή ν‚¤λ” 32λΉ„νΈ κ°’μ…λ‹λ‹¤.

**Payload length(7λΉ„νΈ, 16λΉ„νΈ, 64λΉ„νΈ):** 0-125μ΄λ©΄ νμ΄λ΅λ“ κΈΈμ΄μ…λ‹λ‹¤. 

126μ΄λ©΄ 16λΉ„νΈ λ¶€νΈ μ—†λ” μ •μλ΅ ν•΄μ„λλ” λ‹¤μ 2λ°”μ΄νΈκ°€ νμ΄λ΅λ“ κΈΈμ΄μ…λ‹λ‹¤. 

127μ΄λ©΄ 64λΉ„νΈ λ¶€νΈ μ—†λ” μ •μλ΅ ν•΄μ„λ λ‹¤μ 8λ°”μ΄νΈ(κ°€μ¥ ν° λΉ„νΈλ” 0μ΄μ–΄μ•Ό ν•¨)κ°€ νμ΄λ΅λ“ κΈΈμ΄μ…λ‹λ‹¤.

**Payload Data** - "νμ΄λ΅λ“ λ°μ΄ν„°"λ” "μ• ν”λ¦¬μΌ€μ΄μ… λ°μ΄ν„°"μ™€ μ—°κ²°λ "ν™•μ¥ λ°μ΄ν„°"λ΅ μ •μλ©λ‹λ‹¤.

# Fragments

WebSocketμ—μ„ λ©”μ‹μ§€λ¥Ό λ³΄λ‚Ό λ•, νΉν λ©”μ‹μ§€κ°€ ν¬κ±°λ‚ λ³µμ΅ν• κ²½μ° λ©”μ‹μ§€κ°€ μ—¬λ¬ ν”„λ μ„μΌλ΅ λ¶„ν• λλ” κ²ƒμ΄ μΌλ°μ μ…λ‹λ‹¤. 

μ΄λ• `μ΅°κ°(Fragment)`μ΄ ν•„μ”ν•©λ‹λ‹¤.

`μ΅°κ°(Fragment)`μ„ μ‚¬μ©ν•λ©΄ **λ©”μ‹μ§€λ¥Ό λ” μ‘μ€ μ΅°κ°μΌλ΅ λ¶„ν• ν•  μ μμΌλ©°, κ° μ΅°κ°μ€ λ³„λ„μ ν”„λ μ„μΌλ΅ μ „μ†΅λ©λ‹λ‹¤.**

λ©”μ‹μ§€κ°€ μ΅°κ°μΌλ΅ λ¶„ν• λλ©΄ κ° μ΅°κ°μ€ **μ‹ν€€μ¤μ λ§μ§€λ§‰ ν”„λ μ„μ„ μ μ™Έν• λ¨λ“  ν”„λ μ„μ— λ€ν•΄ FIN λΉ„νΈκ°€ 0μΌλ΅ μ„¤μ •λ μƒνƒλ΅ μ „μ†΅**λ©λ‹λ‹¤. FIN λΉ„νΈλ” ν„μ¬ ν”„λ μ„μ΄ λ©”μ‹μ§€μ λ§μ§€λ§‰ ν”„λ μ„μΈμ§€ μ•„λ‹λ©΄ λ” λ§μ€ ν”„λ μ„μ΄ λ’¤λ”°λ¥Ό κ²ƒμΈμ§€λ¥Ό λ‚νƒ€λƒ…λ‹λ‹¤.

**FIN λΉ„νΈκ°€ 0μΌλ΅ μ„¤μ •λμ–΄ μμΌλ©΄ λ” λ§μ€ ν”„λ μ„μ΄ μ¤κ³  μμΌλ©° μμ‹ μλ” λ©”μ‹μ§€λ¥Ό μ²λ¦¬ν•κΈ° μ „μ— μ¶”κ°€ ν”„λ μ„μ„ κ³„μ† κΈ°λ‹¤λ ¤μ•Ό ν•¨μ„ μλ―Έν•©λ‹λ‹¤.**

λ©”μ‹μ§€μ λ§μ§€λ§‰ μ΅°κ°μ΄ μ „μ†΅λλ©΄ FIN λΉ„νΈκ°€ 1λ΅ μ„¤μ •λ μƒνƒλ΅ μ „μ†΅λ©λ‹λ‹¤. μ΄λ” μμ‹ μμ—κ² μ΄κ²ƒμ΄ λ©”μ‹μ§€μ λ§μ§€λ§‰ ν”„λ μ„μ„μ„ μ•λ¦¬λ” μ‹ νΈμ…λ‹λ‹¤.

# References

[Understanding Websockets In depth](https://vishalrana9915.medium.com/understanding-websockets-in-depth-6eb07ab298b3)