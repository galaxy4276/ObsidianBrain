---
banner: "Archive/images/springboot-banner-01.jpg.jpg"
tags: spring, session, authenication
---
# 분산 세션이 필요한 이유

분산 마이크로서비스에서의 세션 정보는 하나의 애플리케이션에서 유지한다면 동기화 이슈가 발생한다.

마이크로서비스는 근본적으로 탈중앙화가 핵심이기 때문에 서로 다른 서버, 다른 지리적 위치, 별도의 데이터 센터에 상주할 수 있다.

서비스 A가 사용자에 대한 세션을 보유한다면 서비스 B는 사용자의 세션정보를 알 수 없는 문제가 발생한다.

또한 LB 에 의해 사용자의 요청에 의해 매 번 다른 서비스 인스턴스로 요청이 라우팅될 수도 있으므로 세션은 별도로 관리하여야 한다.

그리고 특정한 서비스에서 세션을 관리한다해도 해당 정보들은 메모리에서 관리되기 때문에 인스턴스에 장애가 발생할 경우 세션 정보가 손실된다.
그렇게 되면 사용자는 새로운 세션을 시작해야하므로 사용자 경험이 저하되고 잠재적으로 데이터 손실이 발생할 수도 있다.

이러한 문제를 해결하기 위한 탄생한 것이 **중앙 집중식 세션 저장소** 이다.

# 중앙 집중식 세션 저장소(Centralized Session Store)
이 접근 방식은 모든 세션 데이터를 모든 서비스가 액세스할 수 있는 중앙 집중식 데이터 저장소에 저장하는 것이다.
데이터 저장소는 캐시, 데이터베이스 또는 빠른 액세스를 지원하는 모든 저장 메커니즘이 될 수 있다.

> [!Most Usage]
> Redis, Memcached, RDB(PostgreSQL 또는 MySQL)


# Spring Session

Spring Session 라이브러리를 사용하면 중앙 스토어와 세션의 통합이 더욱 간소화된다.
```java
// Configuration  
@EnableRedisHttpSession  
public class SessionConfig extends AbstractHttpSessionApplicationInitializer {  
	@Bean  
	public LettuceConnectionFactory connectionFactory() {  
		return new LettuceConnectionFactory();  
	}  
}
```
###  장점:
- **통일성:** 모든 서비스가 동일한 데이터 저장소와 상호 작용하여 데이터 일관성을 보장한다.
- **확장성:** Redis와 같은 데이터 저장소는 초당 많은 수의 작업을 처리하도록 설계되어 트래픽이 많은 애플리케이션에 적합하다.
- **복원력:** 이러한 데이터 저장소의 대부분은 복제 및 클러스터링을 지원하여 일부 노드에 장애가 발생하더라도 데이터 가용성을 보장한다.

# 보안 고려 사항

MSA 는 확장성과 유연성을 제공하지만 보안 측면에서 복잡성이 존재한다.
분산 세션 관리는 데이터 무결성과 기밀성을 보장하기 위해 세심한 고려가 필요한 측면이며 핵심 사항은 다음과 같다.

## 데이터 암호화

* 중앙 저장소에 저장하던 토큰 방식으로 저장하던 암호화는 중요하다.
  RDBMS 를 위한 TDE(투명 데이터 암호화) 도구나 Redis 의 기본 암호화 기능을 활용하자.
* 전송 중인 데이터는 항상 SSL/TLS 를 사용하여 보호해야만 한다.

> [!Why Using SSL/TLS]
> 악의적인 공격자가 중간에서 패킷을 가로채더라도 해독할 수 없도록 보호조치를 취하기 위해서

## 보안 쿠키 정책
*  `HttpOnly` 를 표시하여 클라이언트 사이드에서 쿠키에 접근하는 것을 방지하여 `XSS 공격`을 완화해야 한다.
* `사이트 간 위조 공격(CSRF)` 을 방지하는데 도움이 될 수 있는 쿠키에 `SameSite 속성`을 사용하는 것을 고려해야 한다.

